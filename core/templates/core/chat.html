{% extends 'core/base.html' %}
{% block content %}
  <h2>Chat</h2>

  {% if user_prompt|default:"" %}
    <div>
      <strong>Custom Prompt Applied:</strong>
      <div class="custom-prompt-box" aria-live="polite">
        {{ user_prompt|linebreaksbr }}
      </div>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="chat-form-row">
      <div>
        <label for="id_question">Ask your question:</label><br>
        <textarea id="id_question" name="question" rows="3">{{ request.POST.question }}</textarea>
      </div>

      <div class="file-row">
        <label for="id_audio_file" style="margin-right:.25rem;">Or upload voice:</label>
        <input type="file" id="id_audio_file" name="audio_file" accept="audio/*">
        <small style="color:#666;">(max 30s recommended)</small>
      </div>

      <div>
        <button type="submit" class="btn-primary">Ask</button>
      </div>
    </div>
  </form>

  <hr>

  {% if is_voice and transcript %}
    <h3>Transcript:</h3>
    <blockquote class="transcript">{{ transcript }}</blockquote>
  {% endif %}

  {% if error %}
    <div class="alert-danger">Error: {{ error }}</div>
  {% endif %}

  {% if sql %}
    <h3>Generated SQL:</h3>
    <pre class="sql-pre" aria-label="Generated SQL">{{ sql }}</pre>
  {% endif %}

  {% if response %}
    <h3>Results:</h3>
    <div class="chat-results">
      {% for row in response %}
        <div class="chat-row">{{ row }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}
